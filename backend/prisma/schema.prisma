// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  LOCALITE
  COMITE_PEDAGOGIQUE
  COMITE_ADMIN
  ZONE_ADMIN
  CONCLAVE_ADMIN
  SOUS_LOCALITE_ADMIN
  SECTION_USER
  ORG_UNIT_RESP
}

enum ScopeType {
  LOCALITE
  SOUS_LOCALITE
  SECTION
}

enum BureauScopeType {
  LOCALITE
  SOUS_LOCALITE
  SECTION
  ORG_UNIT_INSTANCE
}

enum BureauGroupe {
  S1S2
  S3
}

enum BureauAffectationKind {
  TITULAIRE
  ADJOINT
}

enum BureauSlotType {
  PRIMARY
  EXTRA
}

enum OrgUnitKind {
  CELLULE
  COMMISSION
}

enum OrgUnitRubrique {
  CELLULES_S3
  COMMISSIONS_S1S2
}

enum OrgUnitScopeType {
  LOCALITE
  SECTION
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  role                UserRole
  name                String
  localiteId           String?   @map("localite_id")
  conclaveId           String?   @map("conclave_id")
  zoneId               String?   @map("zone_id")
  comiteId             String?   @map("comite_id")
  sousLocaliteId      String?   @map("sous_localite_id")
  sectionId           String?   @map("section_id")
  refreshToken        String?   @map("refresh_token")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  mustChangePassword  Boolean   @default(false) @map("must_change_password")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  localite    Localite?    @relation(fields: [localiteId], references: [id], onDelete: SetNull)
  conclave    Conclave?    @relation(fields: [conclaveId], references: [id], onDelete: SetNull)
  zone        Zone?        @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  comite      Comite?      @relation(fields: [comiteId], references: [id], onDelete: SetNull)
  sousLocalite SousLocalite? @relation(fields: [sousLocaliteId], references: [id], onDelete: SetNull)
  section      Section?      @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  createdSousLocalites SousLocalite[]  @relation("CreatedBy")
  createdSections      Section[]       @relation("CreatedBy")
  createdTypes         RencontreType[] @relation("TypeCreatedBy")
  createdRencontres    Rencontre[]     @relation("CreatedBy")
  updatedRencontres    Rencontre[]     @relation("UpdatedBy")

  orgUnitAssignments OrgUnitAssignment[]
  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")

  @@index([localiteId])
  @@index([conclaveId])
  @@index([zoneId])
  @@index([comiteId])
  @@map("users")
}

model Conclave {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  zones Zone[]
  users User[]

  @@map("conclaves")
}

model Zone {
  id         String   @id @default(uuid())
  name       String
  conclaveId String?  @map("conclave_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  conclave Conclave? @relation(fields: [conclaveId], references: [id], onDelete: SetNull)
  comites  Comite[]
  users    User[]

  @@index([conclaveId])
  @@unique([conclaveId, name])
  @@map("zones")
}

model Comite {
  id        String   @id @default(uuid())
  name      String
  zoneId    String?  @map("zone_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  zone      Zone?      @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  localites Localite[]
  users     User[]

  @@index([zoneId])
  @@unique([zoneId, name])
  @@map("comites")
}

model Localite {
  id        String   @id @default(uuid())
  name      String   @unique
  comiteId  String?  @map("comite_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  comite       Comite?       @relation(fields: [comiteId], references: [id], onDelete: SetNull)
  sousLocalites SousLocalite[]
  users       User[]

  @@index([comiteId])
  @@map("localites")
}

model SousLocalite {
  id          String   @id @default(uuid())
  name        String
  localiteId  String   @map("localite_id")
  createdById String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  localite  Localite  @relation(fields: [localiteId], references: [id], onDelete: Cascade)
  createdBy User      @relation("CreatedBy", fields: [createdById], references: [id])
  sections  Section[]
  users     User[]

  @@map("sous_localites")
}

model Section {
  id             String   @id @default(uuid())
  name           String
  sousLocaliteId String   @map("sous_localite_id")
  createdById    String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  sousLocalite SousLocalite @relation(fields: [sousLocaliteId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("CreatedBy", fields: [createdById], references: [id])
  rencontres   Rencontre[]
  users        User[]
  membres      Membre[]
  binomeCycles BinomeCycle[]

  @@map("sections")
}

model OrgUnitDefinition {
  id        String         @id @default(uuid())
  kind      OrgUnitKind
  code      String
  name      String
  rubrique  OrgUnitRubrique
  isActive  Boolean        @default(true) @map("is_active")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  instances OrgUnitInstance[]
  pvConfig  OrgUnitPvConfig?

  @@unique([kind, code])
  @@index([rubrique])
  @@index([isActive])
  @@map("org_unit_definitions")
}

model OrgUnitPvConfig {
  id           String   @id @default(uuid())
  definitionId String   @unique @map("definition_id")
  fields       Json     @map("fields")
  typeIds      Json?    @map("type_ids")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  definition OrgUnitDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  @@index([definitionId])
  @@map("org_unit_pv_configs")
}

model OrgUnitInstance {
  id           String           @id @default(uuid())
  definitionId String           @map("definition_id")
  scopeType    OrgUnitScopeType @map("scope_type")
  scopeId      String           @map("scope_id")
  isVisible    Boolean          @default(true) @map("is_visible")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  definition OrgUnitDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  assignments OrgUnitAssignment[]
  members     OrgUnitMember[]
  pv          OrgUnitPv?

  @@index([definitionId])
  @@index([scopeType])
  @@index([scopeId])
  @@unique([definitionId, scopeType, scopeId])
  @@map("org_unit_instances")
}

model OrgUnitPv {
  id         String   @id @default(uuid())
  instanceId String   @unique @map("instance_id")
  content    String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  instance OrgUnitInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@map("org_unit_pvs")
}

model OrgUnitAssignment {
  id         String          @id @default(uuid())
  instanceId String          @map("instance_id")
  userId     String          @map("user_id")
  positionIndex Int          @default(0) @map("position_index")
  createdAt  DateTime        @default(now()) @map("created_at")

  instance OrgUnitInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([userId])
  @@unique([instanceId, userId])
  @@map("org_unit_assignments")
}

model OrgUnitMember {
  id         String   @id @default(uuid())
  instanceId String   @map("instance_id")
  membreId   String   @map("membre_id")
  createdAt  DateTime @default(now()) @map("created_at")

  instance OrgUnitInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  membre   Membre          @relation(fields: [membreId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([membreId])
  @@unique([instanceId, membreId])
  @@map("org_unit_members")
}

model Membre {
  id                  String    @id @default(uuid())
  sectionId           String    @map("section_id")
  photo               String?
  prenom              String
  nom                 String
  genre               String?
  fonction            String?
  corpsMetier         String?   @map("corps_metier")
  groupeSanguin       String?   @map("groupe_sanguin")
  telephone           String?
  numeroCNI           String?   @map("numero_cni")
  adresse             String?
  dateNaissance       DateTime? @map("date_naissance")
  ageTranche           String?   @map("age_tranche")
  dateAdhesion        DateTime? @map("date_adhesion")
  numeroCarteElecteur String?   @map("numero_carte_electeur")
  lieuVote            String?   @map("lieu_vote")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  section        Section     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  rencontresLieu Rencontre[] @relation("RencontreLieuMembre")
  binomePairsA   BinomePair[] @relation("BinomePairMembreA")
  binomePairsB   BinomePair[] @relation("BinomePairMembreB")

  bureauAffectations BureauAffectation[]
  orgUnitMemberships OrgUnitMember[]

  @@map("membres")
}

model BureauPoste {
  id        String         @id @default(uuid())
  name      String
  scopeType BureauScopeType @map("scope_type")
  scopeId   String          @map("scope_id")
  groupe    BureauGroupe
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  affectations BureauAffectation[]

  @@index([scopeType, scopeId])
  @@index([groupe])
  @@unique([scopeType, scopeId, groupe, name])
  @@map("bureau_postes")
}

model BureauAffectation {
  id        String              @id @default(uuid())
  posteId   String              @map("poste_id")
  membreId  String              @map("membre_id")
  kind      BureauAffectationKind
  slotType  BureauSlotType      @default(EXTRA) @map("slot_type")
  slotIndex Int                 @default(0) @map("slot_index")
  createdAt DateTime            @default(now()) @map("created_at")

  poste  BureauPoste @relation(fields: [posteId], references: [id], onDelete: Cascade)
  membre Membre      @relation(fields: [membreId], references: [id], onDelete: Cascade)

  @@index([posteId])
  @@index([membreId])
  @@unique([posteId, kind, slotType, slotIndex])
  @@map("bureau_affectations")
}

model RencontreType {
  id           String     @id @default(uuid())
  name         String
  isReunion    Boolean    @default(false) @map("is_reunion")
  createdById  String?    @map("created_by")
  scopeType    ScopeType? @map("scope_type")
  scopeId      String?    @map("scope_id")
  trancheAgeId String?    @map("tranche_age_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  createdBy  User?       @relation("TypeCreatedBy", fields: [createdById], references: [id])
  trancheAge TrancheAge? @relation(fields: [trancheAgeId], references: [id], onDelete: SetNull)
  rencontres Rencontre[]

  @@index([scopeType, scopeId])
  @@index([trancheAgeId])
  @@map("rencontre_types")
}

model TrancheAge {
  id        String   @id @default(uuid())
  name      String   @unique
  ageMin    Int      @map("age_min")
  ageMax    Int?     @map("age_max")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  types RencontreType[]
  binomePairs BinomePair[]

  @@index([order])
  @@map("tranches_age")
}

model Rencontre {
  id              String    @id @default(uuid())
  typeId          String    @map("type_id")
  sectionId       String    @map("section_id")
  scopeType       ScopeType @map("scope_type")
  scopeId         String    @map("scope_id")
  lieuMembreId    String?   @map("lieu_membre_id")
  lieuTexte       String?   @map("lieu_texte")
  date            DateTime  @db.Date
  heureDebut      String    @map("heure_debut")
  heureFin        String    @map("heure_fin")
  moderateur      String
  moniteur        String
  theme           String?
  ordreDuJour     Json?     @map("ordre_du_jour")
  developpement   String?   @db.Text
  pvReunion       String?   @map("pv_reunion") @db.Text
  membresPresents Json?     @map("membres_presents")
  presenceHomme   Int       @default(0) @map("presence_homme")
  presenceFemme   Int       @default(0) @map("presence_femme")
  presenceTotale  Int       @default(0) @map("presence_totale")
  observations    String?   @db.Text
  attachments     Json?
  createdById     String    @map("created_by")
  updatedById     String?   @map("updated_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  type       RencontreType @relation(fields: [typeId], references: [id])
  section    Section       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  lieuMembre Membre?       @relation("RencontreLieuMembre", fields: [lieuMembreId], references: [id], onDelete: SetNull)
  createdBy  User          @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy  User?         @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([sectionId])
  @@index([typeId])
  @@index([date])
  @@index([scopeType, scopeId])
  @@index([lieuMembreId])
  @@map("rencontres")
}

model BinomeCycle {
  id        String   @id @default(uuid())
  sectionId String   @map("section_id")
  startedAt DateTime @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  section Section     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  pairs   BinomePair[]

  @@index([sectionId])
  @@index([isActive])
  @@map("binome_cycles")
}

model BinomePair {
  id           String   @id @default(uuid())
  cycleId      String   @map("cycle_id")
  trancheAgeId String   @map("tranche_age_id")
  genre        String
  membreAId    String   @map("membre_a_id")
  membreBId    String   @map("membre_b_id")
  createdAt    DateTime @default(now()) @map("created_at")

  cycle     BinomeCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  trancheAge TrancheAge @relation(fields: [trancheAgeId], references: [id], onDelete: Cascade)
  membreA   Membre      @relation("BinomePairMembreA", fields: [membreAId], references: [id], onDelete: Cascade)
  membreB   Membre      @relation("BinomePairMembreB", fields: [membreBId], references: [id], onDelete: Cascade)

  @@index([cycleId])
  @@index([trancheAgeId])
  @@index([genre])
  @@unique([cycleId, trancheAgeId, genre, membreAId])
  @@unique([cycleId, trancheAgeId, genre, membreBId])
  @@map("binome_pairs")
}

model Message {
  id          String    @id @default(uuid())
  senderId    String    @map("sender_id")
  recipientId String    @map("recipient_id")
  subject     String
  body        String    @db.Text
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  sender    User @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User @relation("MessagesReceived", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}
